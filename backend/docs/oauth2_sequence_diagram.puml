@startuml OAuth2_Sequence_Diagram
!theme plain
title Secuencia OAuth2 - Diferentes Clientes y Scopes

actor "Usuario" as User
participant "Frontend Web" as WebApp
participant "Mobile App" as MobileApp
participant "OAuth2 Server" as AuthServer
participant "Products API" as ProductsAPI
participant "Reports API" as ReportsAPI
database "Database" as DB

== ConfiguraciÃ³n Inicial de Clientes ==

note over DB
OAuth2 Clients en Base de Datos:
- frontend_web_v1: [read, write, read:products, write:products, read:users]
- mobile_pos_v1: [read, read:products, pos:sales, write:sales]
- reports_api_v1: [read, read:reports, advanced:reports, export:reports]
end note

== Flujo 1: Frontend Web (Permisos Completos) ==

User -> WebApp: Login (user@test.com, password123)
WebApp -> AuthServer: POST /auth/token
note right
grant_type=password
username=user@test.com
password=password123
client_id=frontend_web_v1_abc123
client_secret=web_secret_hash
scope=read write read:products write:products
end note

AuthServer -> DB: Validar client_id + client_secret
DB -> AuthServer: Cliente vÃ¡lido con allowed_scopes
AuthServer -> DB: Validar user credentials
DB -> AuthServer: Usuario vÃ¡lido

AuthServer -> AuthServer: Calcular scopes finales
note right
Scopes solicitados: [read, write, read:products, write:products]
Scopes del cliente: [read, write, read:products, write:products, read:users]
Scopes finales: [read, write, read:products, write:products] âœ…
end note

AuthServer -> AuthServer: Generar JWT token
AuthServer -> WebApp: HTTP 200 + Token
note right
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "token_type": "bearer",
  "expires_in": 3600,
  "scopes": ["read", "write", "read:products", "write:products"]
}
end note

WebApp -> WebApp: Almacenar token

User -> WebApp: Crear nuevo producto
WebApp -> ProductsAPI: POST /products/\nAuthorization: Bearer <token>
ProductsAPI -> ProductsAPI: Extraer y validar token
ProductsAPI -> ProductsAPI: @require_scope("write:products")
note right
Token decodificado:
{
  "sub": "user_123",
  "scopes": ["read", "write", "read:products", "write:products"],
  "exp": 1640995200
}
âœ… "write:products" presente en scopes
end note

ProductsAPI -> DB: Crear producto
DB -> ProductsAPI: Producto creado
ProductsAPI -> WebApp: HTTP 201 Created
WebApp -> User: âœ… Producto creado exitosamente

== Flujo 2: Mobile App (Permisos Limitados) ==

User -> MobileApp: Login (same credentials)
MobileApp -> AuthServer: POST /auth/token
note right
client_id=mobile_pos_v1_def456
client_secret=mobile_secret_hash
scope=read read:products write:sales
end note

AuthServer -> DB: Validar mobile client
DB -> AuthServer: Cliente mÃ³vil vÃ¡lido
AuthServer -> AuthServer: Calcular scopes finales
note right
Scopes solicitados: [read, read:products, write:sales]
Scopes del cliente: [read, read:products, pos:sales, write:sales]
Scopes finales: [read, read:products, write:sales] âœ…
end note

AuthServer -> MobileApp: Token con scopes limitados

User -> MobileApp: Intentar crear producto
MobileApp -> ProductsAPI: POST /products/\nAuthorization: Bearer <mobile_token>
ProductsAPI -> ProductsAPI: @require_scope("write:products")
note right
Token mÃ³vil decodificado:
{
  "sub": "user_123",
  "scopes": ["read", "read:products", "write:sales"],
  "exp": 1640995200
}
âŒ "write:products" NO presente en scopes
end note

ProductsAPI -> MobileApp: HTTP 403 Forbidden
note right
{
  "detail": "Acceso denegado. Scope requerido: write:products. 
            Scopes disponibles: read, read:products, write:sales"
}
end note
MobileApp -> User: âŒ No tienes permisos para crear productos

User -> MobileApp: Consultar productos (operaciÃ³n permitida)
MobileApp -> ProductsAPI: GET /products/\nAuthorization: Bearer <mobile_token>
ProductsAPI -> ProductsAPI: @require_scope("read:products")
note right
âœ… "read:products" presente en token mÃ³vil
end note

ProductsAPI -> DB: Obtener productos
DB -> ProductsAPI: Lista de productos
ProductsAPI -> MobileApp: HTTP 200 + productos
MobileApp -> User: âœ… Lista de productos mostrada

== Flujo 3: API Externa de Reportes ==

User -> ReportsAPI: Request directo con API key
note left: Proceso automÃ¡tico/programado
ReportsAPI -> AuthServer: POST /auth/token
note right
client_id=reports_api_v1_ghi789
client_secret=reports_secret_hash
scope=read:reports advanced:reports
end note

AuthServer -> DB: Validar reports client
AuthServer -> ReportsAPI: Token especializado

ReportsAPI -> ReportsAPI: Generar reporte de ventas
ReportsAPI -> ProductsAPI: GET /products/\n@require_scope("read:products")
note right
Token de reportes:
{
  "scopes": ["read", "read:reports", "advanced:reports"]
}
âŒ "read:products" NO presente
end note

ProductsAPI -> ReportsAPI: HTTP 403 Forbidden
ReportsAPI -> User: âŒ No puede acceder a datos de productos

== ComparaciÃ³n de Capacidades ==

note over WebApp, ReportsAPI
**Resumen de Capacidades por Cliente:**

ğŸ–¥ï¸ **Frontend Web**:
âœ… Leer productos, âœ… Crear productos, âœ… Leer usuarios
âŒ Generar reportes avanzados

ğŸ“± **Mobile App**:
âœ… Leer productos, âŒ Crear productos, âœ… Procesar ventas
âŒ Leer usuarios, âŒ Reportes

ğŸ“Š **Reports API**:
âŒ Leer productos, âŒ Crear productos, âœ… Reportes avanzados
âŒ Procesar ventas, âŒ Leer usuarios

**Principio de Menor Privilegio**: Cada cliente solo tiene los 
permisos mÃ­nimos necesarios para su funciÃ³n especÃ­fica.
end note

@enduml
